---
title: "Writing a reproducible paper in Pagedown^[Corresponding adress: mail@paulcbauer.eu]"
shorttitle: "Writing a reproducible paper in Pagedown"
author:
  - name: Paul C. Bauer
    affiliation: Mannheim Centre for European Social Research
    email: <mail@paulcbauer.eu>
  - name: Camille Landesvatter
    affiliation: Mannheim Centre for European Social Research
    email: <camille.landesvatter@mzes.uni-mannheim.de>
date: 'First version: 20 June, 2021<br>This version: `r format(Sys.time(), "%d %B, %Y")`'
abstract: 'The present paper provides a template for a reproducible scientific paper written in R Markdown. Below I outline some of the "tricks"/code (e.g., referencing tables, sections etc.) I had to figure out to produce this document. The underlying files which produce this document can be downloaded [here](https://drive.google.com/drive/folders/1zJP3cNPrHN-gj0rcmbHQgg-XA0hqDXdd?usp=sharing). I think I got pretty far but there is always room for improvement and more automatization, in parallel to the incredible developments in R and Rstudio (bookdown etc.). I intend to update this file when I discover more convenient code (you can follow any updates through the corresponding [github repo](https://github.com/paulcbauer/Writing_a_reproducable_paper_in_pagedown/)).'
# at least one keyword must be supplied
keywords: [open science, transparency, replication, R, markdown, pagedown]
links-to-footnotes: true
paged-footnotes: true
bibliography: references.bib
output: 
  pagedown::jss_paged:
    template: wp_paged.html
    self_contained: true
    css: ['wp.css', 'wp-fonts.css', 'wp-page.css']
# uncomment this line to produce HTML and PDF in RStudio:
knit: pagedown::chrome_print
---

\clearpage

\renewcommand{\baselinestretch}{0.5}\normalsize
\tableofcontents
\renewcommand{\baselinestretch}{1.1}\normalsize

\clearpage


\newpage
# Why reproducible research (in R)?

Some arguments...

* **Access**: Research is normally funded by taxpayers (researchers are also taxpayers). Hence, it should be freely accessible to everyone without any barriers, e.g., without requiring commercial software. Importantly, researchers from developing countries are even more dependent on free access to knowledge [@Kirsop2005-ro].
* **Reproducability**: Even if you have written a study and analyzed the data yourself you will forget what you did after a few months. A fully reproducible setup will help you to trace back your own steps. Obviously, the same is true for other researchers who may want to understand your work and built on it. It may sound like a joke but why not aim for a document that can be used to reproduce your findings in 500 years. 
* **Errors**: Manual steps in data analysis (e.g., manually copy/pasting values into a table etc.) may introduce errors. R Markdown allows you to **automatize** such steps and/or avoid them.
* **Revisions**: Revising a paper takes much less time if you have all the code you need in one place, i.e., one `.rmd` file. For instance, if you decide to exclude a subset of your data you simply need to insert one line of your code at the beginning and everything is rebuilt/re-estimated automatically.



# Why Pagedown?





\newpage
# Prerequesites

We assume that you are using R on a day-to-day basis and you may have even started to work in R Markdown. If you don't know what R Markdown is watch [this short video](https://vimeo.com/178485416). Also, there is an overview and template for a scientific paper written in R markdown by one of us two (Paul), which follows the same idea and structure just as this review ([github repo](https://github.com/paulcbauer/Writing_a_reproducable_paper_in_rmarkdown/)). The template compiles information, operations, tips and tricks you will very likely need to create a well-formatted scientific paper with R markdown.

Based on R Markdown, Pagedown allows you to create custom and well-formatted (paged) HTML Documents. For a comprehensive overview watch [this video](https://www.rstudio.com/resources/rstudioconf-2019/pagedown-creating-beautiful-pdfs-with-r-markdown-and-css/) which is a record of a talk introducing R's pagedown given by Yihui Xie (who in addition to Romain Lesur developed R's pagedown package). If you are not in a video watching mood find the slides [here](https://slides.yihui.org/2019-rstudio-conf-pagedown.html#1).

Then...

* ...install [R](https://www.r-project.org/) and [Rstudio](https://www.rstudio.com/) (most recent versions) [@R2017; @Rstudio2015].
* ...install the "pagedown"-package from github using the code below.
```{r eval=FALSE, include=TRUE}
remotes::install_github('rstudio/pagedown')
```
* ...also install the packages below using the code below [@bookdown1; @bookdown2; @knitr1; @knitr2; @knitr3; @kableextra; @plotly].
```{r eval=FALSE, include=TRUE}
install.packages(c("rmarkdown", "knitr", "kableExtra",
                   "stargazer", "modelsummary", "plotly", "knitr"))
```
* ...download the 4 input files we created --- `paper.rmd`, `references.bib`, `data.csv` and `american-sociological-association.csl` --- from [this folder](https://drive.google.com/drive/folders/1zJP3cNPrHN-gj0rcmbHQgg-XA0hqDXdd?usp=sharing). Ignore the other files.
* ...also download the 4 styling files we created: `wp_paged.html`, `wp.css`, `wp-fonts.css` and `wp-pages.css`.
* ...store all 8 files from above together in one folder (and use this folder as your working directory later on)
* ...learn R and read about the other underlying components namely [Markdown](https://en.wikipedia.org/wiki/Markdown), [R Markdown](https://rmarkdown.rstudio.com/lesson-1.html) and [Latex](https://en.wikipedia.org/wiki/LaTeX).
* ...pagedown comes with several Rmd-templates (presentations, poster, thesis, etc.) and via this review we provide another template for a working paper style. If however you want to modify single aspects or create your own template, you will need at least some basic skills in [CSS](https://www.w3schools.com/css/) and [HTML](https://www.w3schools.com/html/).





# Basics: Input and output files

All the files you need to produce the present PDF file are:

1. the input files:

* `paper.rmd` (the underlying R Markdown file).
* `references.bib` (the bibliography).
    + I use paperpile to manage my references and export the `.bib` file into the folder that contains my `.rmd` file.
* `data.csv` (some raw data).
* `american-sociological-association.csl` (defines the style of your bibliography).^[You can download various citation style files from this webpage: https://github.com/citation-style-language/styles.] 

2. the "styling" files:

Basically, these are files you will need to specify in the YAML of your rmd-file, so that R and ultimately pagedown recognizes the certain style you want to achieve for your document. With using our templates, you will create a document that has the "look" of a working paper. 

* `wp_paged.html`
* `wp.css`
* `wp-fonts.css`
* `wp-pages.css`

Take `paper.rmd` (the underlying R Markdown file of this pdf) and have a look at the YAML (line 18-22) to see how to specifiy these files.
Basically, what happens here is that within the [jss_paged function](https://rdrr.io/cran/pagedown/man/jss_paged.html) we additionally specify that we want to use custom css and html.

[Download these files](https://drive.google.com/drive/folders/1zJP3cNPrHN-gj0rcmbHQgg-XA0hqDXdd?usp=sharing) and save them into a folder. Close R/Rstudio and directly open `paper.rmd` with RStudio. Doing so assures that the working directory is set to the folder that contains `paper.rmd` and the other files.^[You can always check your working directory in R with `getwd()`.]

Once you run/compile the `paper.rmd` file in Rstudio it creates mainly one output files:

* `paper_pagedown.html` (the one you are reading right now)

By using pagedown's `chrome_print` function in the YAML (uncomment the line) your html based web page will be printed to be PDF (the PDF will be stored in your working directory)

* `paper_pagedown.pdf`



\newpage
# Referencing within your document

To see how referencing works simply see the different examples for figures, tables and sections below. For instance in Section \@ref(sec:tables) you can find different ways of referencing tables. The code of the underlying `paper.rmd` will show you how I referenced Section \@ref(sec:tables) right here namely with '`Section \@ref(sec:tables)`'.



# Software versioning

Software changes and gets updated, especially with an active developer community like that of R. Luckily you can always access [old versions of R](https://cran.r-project.org/bin/windows/base/old/) and old version of R packages in [the archive](https://cran.r-project.org/src/contrib/Archive/). In the archive you need to choose a particular package, e.g dplyr and search for the right version, e.g., `dplyr_0.2.tar.gz`. Then insert the path in the following function: `install.packages("https://....../dplyr_0.2.tar.gz", repos=NULL, type="source")`. Ideally, however, results will be simply reproducible in the most current R and package versions.

I would recommend to use the command below and simply add it to the appendix as I did here in Appendix \@ref(sec:rsessioninfo). This will make sure you always provide the package versions that you used in the last compilation of your paper. For more advanced tools see [packrat](https://rstudio.github.io/packrat/).

```{r fig-versioning, echo=TRUE, eval=FALSE}
cat(paste("#", capture.output(sessionInfo()), "\n", collapse ="")) 
  # or use message() instead of cat()
```





\newpage
# Data
## Import

Generally, code is evaluated by inserting regular [R Markdown]{.proglang} blocks.

```{r}
x <- 1:10
x
```

Below we import an exemplary dataset ([download](https://drive.google.com/drive/folders/1zJP3cNPrHN-gj0rcmbHQgg-XA0hqDXdd?usp=sharing)).

```{r, echo=T, results="raw"}
data <- read.csv("data.csv")
head(data)
```


# Tables {#sec:tables}

Producing good tables and referencing these tables within a R Markdown PDF has been a hassle but got much better. Examples that you may use are shown below. The way you reference tables is slightly different, e.g., for `stargazer` the label is contained in the function, for `kable` it's contained in the chunk name.

## stargazer(): Summary and regression tables

### Summary table with stargazer

Table \@ref(tab1) shows summary stats of your data.^[To reference the table where you set the identifier in the stargazer function you only need to use the actual label, i.e., ´tab1´.] I normally use `stargazer()` [@hlavac2013stargazer] which offers extreme flexibility regarding table output (see `?stargazer`). 

```{r, echo=TRUE, message=FALSE, warning=FALSE, results="asis"}
library(stargazer)
stargazer(cars, 
          label="tab1", 
          table.placement = "H", 
          type="html",
          header=FALSE)
```


### Regression table with stargazer

Table \@ref(tab2) shows the output for a regression table. Make sure you name all your models and explicitly refer to model names (M1, M2 etc.) in the text.

```{r, echo=TRUE, message=FALSE, warning=FALSE, results="asis"}
library(stargazer)
model1 <- lm(speed ~ dist, data = cars)
model2 <- lm(speed ~ dist, data = cars)
model3 <- lm(dist ~ speed, data = cars)

stargazer(model1, model2, model3,
          label="tab2",
          table.placement = "H", 
          column.labels = c("M1", "M2", "M3"),
          type="html",
          model.numbers = FALSE,
          header=FALSE)
```




## kable() and kable_styling()

Another great function is `kable()` (`knitr` package) in combination with `kableExtra`. Table \@ref(tab:tab3) provides an example.^[To reference the table produced by the chunk you need to add ´tab:´ to the chunk name, i.e., ´tab:tab3´.]

```{r tab3, echo=TRUE, message=FALSE, warning=FALSE, results="asis"}
library(knitr)
library(kableExtra)

kable(mtcars[1:10,], row.names = TRUE, 
      caption = 'Table with kable() and kablestyling()', 
      format = "html", booktabs = T) %>%
        kable_styling(full_width = T, 
                      latex_options = c("striped", 
                                        "scale_down",
                                        "HOLD_position"),
                      font_size = 10)


```


## modelsummary

The `modelsummary` package provides a variety of tables and plots to summarize statistical models and data in R. Modellsummary plots and tables are highly customizable and they can be saved to almost all formats, e.g., HTML, PDF and Markdown. This makes ist especially easzz to embed them in dznmaic documents.

Please look at the package's extensive [documentation](https://vincentarelbundock.github.io/modelsummary/index.html) where they also show examples for almost any plot or table you might be looking for.

In this template we demonstrate an example for modelsummary's `datasummary` function. `Datasummary` creates frequency tables, crosstab tables, correlation tables, balance tables and many **more**.

### Summarize numeric variables with modelsummary

Table \@ref(tab:tab4) shows a summary table for numeric variables. 

```{r tab4, echo=TRUE, message=FALSE, warning=FALSE, results="asis"}
library(modelsummary)

mtcars_df <- mtcars
mtcars_df$vs <- as.logical(mtcars_df$vs)
mtcars_df$cyl <- as.factor(mtcars_df$cyl)
datasummary_skim(mtcars, type="numeric", output="html", histogram=T)
```

### Summarize categorical variables with modelsummary

Table \@ref(tab:tab5) shows a summary table for categorical variables. 

```{r tab5, echo=TRUE, message=FALSE, warning=FALSE, results="asis"}
datasummary_skim(mtcars_df, type="categorical", output="html")
```


# Inline code & results








# Figures

## R base graphs
Inserting figures can be slightly more complicated. Ideally, we would produce and insert them directly in the `.rmd` file. It's relatively simple to insert R base graphs as you can see in Figure \@ref(fig:fig-1).

```{r fig-1, fig.align="center", fig.cap="Scatterplot of Speed and Distance", fig.pos="H", message=FALSE, warning=FALSE, paged.print=FALSE}
plot(cars$speed, cars$dist)
``` 

But it turns out that it doesn't always work so well. 

## ggplot2 graphs
Same is true for ggplot2 as you can see in Figure \@ref(fig:fig-2).

```{r fig-2, fig.align="center", fig.cap="Miles per gallon according to the weight", fig.pos="H", fig.width=6, fig.height=3, message=FALSE, warning=FALSE, paged.print=FALSE}
mtcars$cyl <- as.factor(mtcars$cyl) # Convert cyl to factor
library(ggplot2)
ggplot(mtcars, aes(x=wt, y=mpg, shape=cyl)) + geom_point() +
  labs(x="Weight (lb/1000)", y = "Miles/(US) gallon", 
       shape="Number of \n Cylinders") + theme_classic()
``` 

## Interactive graphs








# Compiling 

To view your paper, pagedown requires a web server (since it is based von paged.js)^(open-source library to paginate content in the browser). By compiling a document, R Studio will display your HTML page through a local web server, i.e., paged.js will work in RStudio Viewer.

There are several options, depending on your intention.

- click on the `Knit` button which by default will provide a html document in the RStudio viewer pane (the html will be stored in your working directory)
- use pagedown's `chrome_print` function in the YAML (uncomment line \#24 of this `Rmd` file) if you want your html based web page to be (additionally to the html!) printed to be PDF (the PDF will be stored in your working directory)
- to "live"-preview your pages do not click on the `Knit` button but use the **xaringan** [@xaringan] RStudio add-in _Infinite Moon Reader_. You can simply call the function `xaringan::inf_mr()` (within your console). This will launch a local web server via the **servr** package (Xie 2021a) and display your pages in the RStudio viewer. Each time you save your document (_Ctrl+S_) xaringan updates your pages in the viewer.

- If you use the option `self_contained: false` (see line \#21 of this `Rmd` file) (change to true for a self-contained document, but it'll be a litte slower for Pandoc to render), don't click on the `Knit` button in RStudio. Use instead the **xaringan** [@xaringan] RStudio add-in _Infinite Moon Reader_.




# Good practices
Every researcher has his own optimized setup. Currently I would recommend the following:

* Keep all files of your project (that matter for producing the PDF) in one folder without subfolders. You can zip and directly upload that folder to the [Harvard dataverse](https://dataverse.harvard.edu/).
* Make sure that filenames have a logic to them.
    + Main file with text/code: "paper.rmd", "report.rmd" 
    + Data files: "data_xxxxxx.*"
    + Image files: "fig_xxxxxx.*"
    + Tables files: "table_xxxx.*"
    + etc.
    + Ideally, your filenames will correspond to the names in the paper. For instance, Figure 1 in the paper may have a corresponding file called `fig_1_xxxxx.pdf`.
* Use the document outline in R studio (Ctrl + Shift + O) when you work with R Markdown.
* Name rchunks according to what they do or produce:
    + "`fig-...`" for chunks producing figures
    + "`table-...`" for chunks producing tables
    + "`model-...`" for chunks producing model estimates
    + "`import-...`" for chunks importing data
    + "`recoding-...`" for chunks in which data is recoded
* Use "really" informative variable names:
    + Q: What do you think does the variable *trstep* measure? It actually measures trust in the European parliament. 
        + How could we call this variable instead? Yes, `trust.european.parliament` which is longer but will probably be understood by another researcher. 
    + If your setup is truly reproducible you will probably re-use the variable names that you generate as variable names in the tables you produce. Hence, there is an incentive to use good names.
* Use unique identifiers in the final document:
    + e.g., name the models you estimate "M1", "M2" etc.
    + These unique names should also appear in the published paper.
    + Think of someone who wants to produce Figure 1/Model 1 in your paper but doesn't find it in your code...

# Additional tricks for publishing
* Make your script anonymous
    + Simply put a `<!-- ... -->` around any identifying information, e.g., author names, title footnote etc.
* Counting words
    + Use adobe acrobat (commerical software) to convert your file to a word file. Then open in word and delete all the parts that shouldn't go into the word count. The word count is displayed in the lower right.
    + Use an one of the online services to count your words (search for "pdf word count")
* Appendix: You can change the numbering format for the appendix in the rmd file
    + What is still not possible in this document is to automatically have separate reference sections for paper and appendix.
* Journals may require you to use their tex style: Sometimes you can simply use their template in your rmarkdown file. See [here](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/LDUMNY) for a PLOS one example.

# Citation styles
If your study needs to follow a particular citation style, you can set the corresponding style in the header of your `.rmd` document. To do so you have to download the corresponding `.csl` file.     

In the present document we use the style of the American Sociological Association and set it in the preamble with `csl: american-sociological-association.csl`. However, you also need to download the respective `.csl` file from the following github page: https://github.com/citation-style-language/styles and copy it into your working directory for it to work.     

The github directory contains a wide variety of citation style files depending on what discipline you work in.


# References {-}

::: {#refs}

:::

<!--  to generate a citation entry for BibTeX, you can pass the returned object of citation() to toBibtex(), e.g. toBibtex(citation("xaringan")). Then  copy the output to a .bib file and add a unique citation key -->
<!-- https://bookdown.org/yihui/rmarkdown-cookbook/write-bib.html -->




# Online appendix {-}

## Attach R session info in appendix {#sec:rsessioninfo}

Since R and R packages are constantly evolving you might want to add the R session info that contains information on the R version as well as the packages that are loaded. 

```{r echo=FALSE}
print(sessionInfo(), local = FALSE)
```

## All the code in the paper

To simply attach all the code you used in the PDF file in the appendix see the R chunk in the underlying `.rmd` file:

```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}
```




